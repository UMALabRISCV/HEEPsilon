# HEEPsilon CI Workflow
# 
# Full simulation tests with Docker environment.
#
# SPDX-License-Identifier: Apache-2.0

name: üèóÔ∏è Full Simulation CI (Docker)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  DOCKER_IMAGE: heepsilon-dev

jobs:
  # ==========================================================================
  # Build (Docker + MCU + Verilator + All Apps in single job)
  # ==========================================================================
  build:
    name: Build Docker & Verilator
    runs-on: ubuntu-latest
    
    steps:
      - name: Free disk space
        run: |
          echo "=== Disk usage before cleanup ==="
          df -h
          # Aggressive cleanup to free ~30GB
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo rm -rf /opt/hostedtoolcache/go || true
          sudo rm -rf /opt/hostedtoolcache/node || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /usr/local/graalvm || true
          sudo rm -rf /usr/local/share/powershell || true
          sudo rm -rf /usr/local/share/chromium || true
          sudo rm -rf /usr/local/lib/node_modules || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
          sudo docker image prune -af || true
          sudo apt-get clean || true
          echo "=== Disk usage after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: util/docker/Dockerfile
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify tools
        run: |
          docker run --rm ${{ env.DOCKER_IMAGE }} verilator --version
          docker run --rm ${{ env.DOCKER_IMAGE }} verible-verilog-format --version

      - name: Generate MCU and build Verilator
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/heepsilon \
            -w /workspace/heepsilon \
            ${{ env.DOCKER_IMAGE }} \
            bash -c "make mcu-gen && make verilator-sim"

      - name: Build all test applications
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/heepsilon \
            -w /workspace/heepsilon \
            ${{ env.DOCKER_IMAGE }} \
            bash -c "
              for app in hello_world cgra_func_test cgra_simple_add cgra_load_store_test cgra_dbl_search cgra_fft cgra_pmean cgra_check_conf; do
                echo '=== Building \$app ==='
                make app PROJECT=\$app
                mkdir -p sw/build/\$app
                cp sw/build/main.hex sw/build/\$app/
                cp sw/build/main.elf sw/build/\$app/ 2>/dev/null || true
              done
            "

      - name: Upload Verilator simulator
        uses: actions/upload-artifact@v4
        with:
          name: verilator-sim
          path: build/eslepfl_systems_heepsilon_0/sim-verilator/
          retention-days: 1

      - name: Upload compiled applications
        uses: actions/upload-artifact@v4
        with:
          name: app-binaries
          path: sw/build/
          retention-days: 1

  # ==========================================================================
  # CPU Test
  # ==========================================================================
  test-cpu:
    name: Test CPU (hello_world)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Verilator simulator
        uses: actions/download-artifact@v4
        with:
          name: verilator-sim
          path: sim/

      - name: Download applications
        uses: actions/download-artifact@v4
        with:
          name: app-binaries
          path: apps/

      - name: Run hello_world simulation
        run: |
          chmod +x sim/Vtestharness
          
          # Copy firmware to simulation directory to be safe
          cp apps/hello_world/main.hex sim/firmware.hex
          
          cd sim
          # Use local relative path
          ./Vtestharness +firmware=firmware.hex -V

      - name: Verify output
        run: |
          if grep -q "hello world!" sim/uart0.log; then
            echo "‚úÖ hello_world PASSED"
            cat sim/uart0.log
          else
            echo "‚ùå hello_world FAILED"
            cat sim/uart0.log || true
            exit 1
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-cpu-hello_world
          path: sim/uart0.log
          retention-days: 7

  # ==========================================================================
  # CGRA Tests
  # ==========================================================================
  test-cgra:
    name: Test CGRA (${{ matrix.app }})
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        app:
          - cgra_func_test
          - cgra_simple_add
          - cgra_load_store_test
          - cgra_dbl_search
          - cgra_fft
          - cgra_pmean
          - cgra_check_conf

    steps:
      - name: Download Verilator simulator
        uses: actions/download-artifact@v4
        with:
          name: verilator-sim
          path: sim/

      - name: Download applications
        uses: actions/download-artifact@v4
        with:
          name: app-binaries
          path: apps/

      - name: Run ${{ matrix.app }}
        run: |
          chmod +x sim/Vtestharness
          
          # Copy firmware to simulation directory
          cp apps/${{ matrix.app }}/main.hex sim/firmware.hex
          
          cd sim
          # Clean previous logs
          rm -f uart0.log
          
          # Use local relative path
          ./Vtestharness +firmware=firmware.hex || true

      - name: Verify output
        run: |
          LOG="sim/uart0.log"
          if [ -f "$LOG" ]; then
            cat "$LOG"
            if grep -qE "Program Finished with value 0|SUCCESS|PASSED" "$LOG"; then
              echo "‚úÖ ${{ matrix.app }} PASSED"
            elif grep -qE "FAIL|ERROR" "$LOG"; then
              echo "‚ùå ${{ matrix.app }} FAILED"; exit 1
            else
              echo "‚ö†Ô∏è ${{ matrix.app }} completed (check logs)"
            fi
          else
            echo "‚ùå No log found"; exit 1
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-cgra-${{ matrix.app }}
          path: sim/uart0.log
          retention-days: 7

  # ==========================================================================
  # Summary
  # ==========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [build, test-cpu, test-cgra]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "Build: ${{ needs.build.result }}"
          echo "CPU Tests: ${{ needs.test-cpu.result }}"
          echo "CGRA Tests: ${{ needs.test-cgra.result }}"
          
          if [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.test-cpu.result }}" != "success" ] || \
             [ "${{ needs.test-cgra.result }}" != "success" ]; then
            echo "‚ùå CI failed"; exit 1
          fi
          echo "‚úÖ All CI checks passed!"
