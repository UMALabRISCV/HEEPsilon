# HEEPsilon CI Workflow
# 
# Professional parallel CI with GitHub Container Registry
#
# SPDX-License-Identifier: Apache-2.0

name: ðŸ—ï¸ Full Simulation CI (Docker)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  REGISTRY: ghcr.io

permissions:
  contents: read
  packages: write

jobs:
  # ==========================================================================
  # Build Job - Compiles everything and pushes to GHCR
  # ==========================================================================
  build:
    name: ðŸ”¨ Build
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      image: ${{ steps.image.outputs.name }}
    
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go || true
          sudo rm -rf /usr/local/share/boost /usr/share/swift || true
          sudo docker image prune -af || true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set image name
        id: image
        run: |
          # Docker requires lowercase image names
          IMAGE="${{ env.REGISTRY }}/$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')-ci:${{ github.sha }}"
          echo "name=${IMAGE}" >> $GITHUB_OUTPUT
          echo "Image: ${IMAGE}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build base Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: util/docker/Dockerfile
          push: false
          load: true
          tags: heepsilon-base:latest
          cache-from: type=gha,scope=base
          cache-to: type=gha,mode=max,scope=base

      - name: Generate MCU and build Verilator
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/heepsilon \
            -w /workspace/heepsilon \
            heepsilon-base:latest \
            bash -c "make mcu-gen MEMORY_BANKS=8 && make verilator-sim"

      - name: Create CI image with built artifacts
        run: |
          cat > Dockerfile.ci << 'EOF'
          FROM heepsilon-base:latest
          COPY --chown=root:root . /workspace/heepsilon
          WORKDIR /workspace/heepsilon
          EOF
          
          docker build -f Dockerfile.ci -t ${{ steps.image.outputs.name }} .

      - name: Push to GHCR
        run: docker push ${{ steps.image.outputs.name }}

      - name: Verify build
        run: |
          echo "âœ… Image pushed: ${{ steps.image.outputs.name }}"

  # ==========================================================================
  # CPU Test
  # ==========================================================================
  test-cpu:
    name: ðŸ§ª CPU (hello_world)
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull ${{ needs.build.outputs.image }}

      - name: Run hello_world
        run: |
          docker run --rm ${{ needs.build.outputs.image }} \
            bash -c "make verilator-run-app PROJECT=hello_world && cat build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log"

      - name: Verify output
        run: |
          docker run --rm ${{ needs.build.outputs.image }} \
            bash -c "grep -q 'hello world!' build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log && echo 'âœ… PASSED'"

  # ==========================================================================
  # CGRA Tests (Parallel Matrix)
  # ==========================================================================
  test-cgra:
    name: ðŸ§ª CGRA (${{ matrix.app }})
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        app:
          - cgra_func_test
          - cgra_simple_add
          - cgra_load_store_test
          - cgra_dbl_search
          - cgra_check_conf

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull ${{ needs.build.outputs.image }}

      - name: Run ${{ matrix.app }}
        run: |
          docker run --rm ${{ needs.build.outputs.image }} \
            bash -c "make verilator-run-app PROJECT=${{ matrix.app }} && cat build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log"

  # ==========================================================================
  # CI Status Summary
  # ==========================================================================
  ci-status:
    name: ðŸ“Š CI Status
    runs-on: ubuntu-latest
    needs: [build, test-cpu, test-cgra]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## ðŸ—ï¸ HEEPsilon CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CPU Tests | ${{ needs.test-cpu.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CGRA Tests | ${{ needs.test-cgra.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.test-cpu.result }}" != "success" ] || \
             [ "${{ needs.test-cgra.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **All checks passed!**" >> $GITHUB_STEP_SUMMARY
