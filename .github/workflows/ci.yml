# HEEPsilon CI Workflow
# 
# Builds the Docker environment and runs RTL simulation tests.
# Ensures the simulation infrastructure works correctly on every push/PR.
#
# SPDX-License-Identifier: Apache-2.0

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  DOCKER_IMAGE: heepsilon-dev

jobs:
  # ==========================================================================
  # Docker Build
  # ==========================================================================
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: util/docker/Dockerfile
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify Verilator version
        run: |
          docker run --rm ${{ env.DOCKER_IMAGE }} verilator --version

      - name: Save Docker image
        run: |
          docker save ${{ env.DOCKER_IMAGE }}:latest | gzip > heepsilon-dev.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: heepsilon-dev.tar.gz
          retention-days: 1

  # ==========================================================================
  # MCU Generation
  # ==========================================================================
  mcu-gen:
    name: Generate MCU Configuration
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: |
          gunzip -c heepsilon-dev.tar.gz | docker load

      - name: Run MCU generation
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/heepsilon \
            -w /workspace/heepsilon \
            ${{ env.DOCKER_IMAGE }} \
            bash -c "make mcu-gen"

      - name: Upload generated files
        uses: actions/upload-artifact@v4
        with:
          name: mcu-generated
          path: |
            sw/
            hw/
          retention-days: 1

  # ==========================================================================
  # Verilator Build
  # ==========================================================================
  verilator-build:
    name: Build Verilator Simulation
    runs-on: ubuntu-latest
    needs: mcu-gen

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Download MCU generated files
        uses: actions/download-artifact@v4
        with:
          name: mcu-generated

      - name: Load Docker image
        run: |
          gunzip -c heepsilon-dev.tar.gz | docker load

      - name: Build Verilator simulation
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/heepsilon \
            -w /workspace/heepsilon \
            ${{ env.DOCKER_IMAGE }} \
            bash -c "make verilator-sim"

      - name: Upload Verilator build
        uses: actions/upload-artifact@v4
        with:
          name: verilator-build
          path: build/
          retention-days: 1

  # ==========================================================================
  # Simulation Tests
  # ==========================================================================
  test-hello-world:
    name: Test hello_world
    runs-on: ubuntu-latest
    needs: verilator-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Download Verilator build
        uses: actions/download-artifact@v4
        with:
          name: verilator-build
          path: build/

      - name: Load Docker image
        run: |
          gunzip -c heepsilon-dev.tar.gz | docker load

      - name: Run hello_world simulation
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/heepsilon \
            -w /workspace/heepsilon \
            ${{ env.DOCKER_IMAGE }} \
            bash -c "make verilator-run-app PROJECT=hello_world"

      - name: Verify simulation output
        run: |
          if grep -q "hello world!" build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log; then
            echo "✅ hello_world test PASSED"
          else
            echo "❌ hello_world test FAILED - expected 'hello world!' in UART output"
            cat build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log || echo "No UART log found"
            exit 1
          fi

      - name: Upload simulation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simulation-logs
          path: |
            build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log
            build/eslepfl_systems_heepsilon_0/sim-verilator/buildsim.log
          retention-days: 7

  # ==========================================================================
  # Summary Job
  # ==========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [docker-build, mcu-gen, verilator-build, test-hello-world]
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.docker-build.result }}" != "success" ] || \
             [ "${{ needs.mcu-gen.result }}" != "success" ] || \
             [ "${{ needs.verilator-build.result }}" != "success" ] || \
             [ "${{ needs.test-hello-world.result }}" != "success" ]; then
            echo "❌ CI failed"
            exit 1
          fi
          echo "✅ All CI checks passed!"
