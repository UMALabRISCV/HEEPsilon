# HEEPsilon CI Workflow
# 
# Full simulation tests with Docker environment.
# For quick lint checks, see lint.yml
#
# SPDX-License-Identifier: Apache-2.0

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  DOCKER_IMAGE: heepsilon-dev

jobs:
  # ==========================================================================
  # Docker Build
  # ==========================================================================
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Free disk space
        run: |
          echo "=== Disk usage before cleanup ==="
          df -h
          # Remove unnecessary tools to free space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          echo "=== Disk usage after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: util/docker/Dockerfile
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify Verilator version
        run: docker run --rm ${{ env.DOCKER_IMAGE }} verilator --version

      - name: Save Docker image
        run: docker save ${{ env.DOCKER_IMAGE }}:latest | gzip > heepsilon-dev.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: heepsilon-dev.tar.gz
          retention-days: 1

  # ==========================================================================
  # Verilator Build
  # ==========================================================================
  verilator-build:
    name: Build Verilator Simulation
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune -af

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: gunzip -c heepsilon-dev.tar.gz | docker load

      - name: Generate MCU and build Verilator
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/heepsilon \
            -w /workspace/heepsilon \
            ${{ env.DOCKER_IMAGE }} \
            bash -c "make mcu-gen && make verilator-sim"

      - name: Upload Verilator build
        uses: actions/upload-artifact@v4
        with:
          name: verilator-build
          path: build/
          retention-days: 1

  # ==========================================================================
  # CPU Test
  # ==========================================================================
  test-cpu:
    name: Test CPU (hello_world)
    runs-on: ubuntu-latest
    needs: verilator-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Download Verilator build
        uses: actions/download-artifact@v4
        with:
          name: verilator-build
          path: build/

      - name: Load Docker image
        run: gunzip -c heepsilon-dev.tar.gz | docker load

      - name: Run hello_world simulation
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/heepsilon \
            -w /workspace/heepsilon \
            ${{ env.DOCKER_IMAGE }} \
            bash -c "make verilator-run-app PROJECT=hello_world"

      - name: Verify output
        run: |
          if grep -q "hello world!" build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log; then
            echo "✅ hello_world PASSED"
          else
            echo "❌ hello_world FAILED"; exit 1
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-cpu-hello_world
          path: build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log
          retention-days: 7

  # ==========================================================================
  # CGRA Tests
  # ==========================================================================
  test-cgra:
    name: Test CGRA (${{ matrix.app }})
    runs-on: ubuntu-latest
    needs: verilator-build
    strategy:
      fail-fast: false
      matrix:
        app:
          - cgra_func_test
          - cgra_simple_add
          - cgra_load_store_test
          - cgra_dbl_search
          - cgra_fft
          - cgra_pmean
          - cgra_check_conf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Download Verilator build
        uses: actions/download-artifact@v4
        with:
          name: verilator-build
          path: build/

      - name: Load Docker image
        run: gunzip -c heepsilon-dev.tar.gz | docker load

      - name: Run ${{ matrix.app }}
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/heepsilon \
            -w /workspace/heepsilon \
            ${{ env.DOCKER_IMAGE }} \
            bash -c "make verilator-run-app PROJECT=${{ matrix.app }}"

      - name: Verify output
        run: |
          LOG="build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log"
          if [ -f "$LOG" ]; then
            cat "$LOG"
            if grep -qE "Program Finished with value 0|SUCCESS|PASSED" "$LOG"; then
              echo "✅ ${{ matrix.app }} PASSED"
            elif grep -qE "FAIL|ERROR" "$LOG"; then
              echo "❌ ${{ matrix.app }} FAILED"; exit 1
            else
              echo "⚠️ ${{ matrix.app }} completed"
            fi
          else
            echo "❌ No log found"; exit 1
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-cgra-${{ matrix.app }}
          path: build/eslepfl_systems_heepsilon_0/sim-verilator/uart0.log
          retention-days: 7

  # ==========================================================================
  # Summary
  # ==========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [docker-build, verilator-build, test-cpu, test-cgra]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "Docker: ${{ needs.docker-build.result }}"
          echo "Verilator: ${{ needs.verilator-build.result }}"
          echo "CPU Tests: ${{ needs.test-cpu.result }}"
          echo "CGRA Tests: ${{ needs.test-cgra.result }}"
          
          if [ "${{ needs.docker-build.result }}" != "success" ] || \
             [ "${{ needs.verilator-build.result }}" != "success" ] || \
             [ "${{ needs.test-cpu.result }}" != "success" ] || \
             [ "${{ needs.test-cgra.result }}" != "success" ]; then
            echo "❌ CI failed"; exit 1
          fi
          echo "✅ All CI checks passed!"
