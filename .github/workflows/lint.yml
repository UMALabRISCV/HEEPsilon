# HEEPsilon Lint Workflow
#
# Fast checks that run on every push and PR.
# For full simulation tests, see ci.yml
#
# SPDX-License-Identifier: Apache-2.0 WITH SHL-2.1

name: Lint

on: [push, pull_request]

env:
  VERIBLE_VERSION: 0.0-1824-ga3b5bedf

jobs:
  # ==========================================================================
  # Vendor Check
  # ==========================================================================
  check-vendor:
    name: Vendor Up-to-Date
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          
      - name: Install requirements
        run: pip install -r hw/vendor/esl_epfl_x_heep/python-requirements.txt
        
      - name: Re-vendor and diff
        run: |
          find . -name '*.vendor.hjson' | xargs -n1 util/vendor.py --verbose
          hw/vendor/esl_epfl_x_heep/util/git-diff.py --error-msg "::error ::Vendored sources out of date. Run vendor.py to update."

  # ==========================================================================
  # MCU Generation Check
  # ==========================================================================
  check-mcu-gen:
    name: MCU Generated Files
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - uses: actions/setup-python@v4
        with:
          python-version: "3.8"
          
      - name: Setup Python environment
        run: |
          make venv
          . ./.venv/bin/activate
          pip install -r hw/vendor/esl_epfl_x_heep/python-requirements.txt
          
      - name: Install Verible
        run: |
          mkdir -p build/verible
          cd build/verible
          curl -Ls -o verible.tar.gz \
            "https://github.com/google/verible/releases/download/v${VERIBLE_VERSION}/verible-v${VERIBLE_VERSION}-Ubuntu-18.04-bionic-x86_64.tar.gz"
          sudo mkdir -p /tools/verible && sudo chmod 777 /tools/verible
          tar -C /tools/verible -xf verible.tar.gz --strip-components=1
          echo "/tools/verible/bin" >> $GITHUB_PATH
          
      - name: Run MCU generation
        run: |
          . ./.venv/bin/activate
          make mcu-gen
          
      - name: Check for uncommitted changes
        run: |
          hw/vendor/esl_epfl_x_heep/util/git-diff.py \
            --error-msg "::error ::Generated files differ from repository. Run 'make mcu-gen' and commit."
